<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ ADVANCED AVIATION SAFETY MONITOR</title>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
        :root {
            --bg-main: #1E1E2F;
            --bg-card: #27293D;
            --text-primary: #E0E0E0;
            --text-secondary: #B0B0C4;
            --accent-primary: #4DD0E1; /* Cyan */
            --accent-secondary: #FFCA28; /* Yellow/Gold */
            --danger: #EF5350; /* Red */
            --success: #66BB6A; /* Green */
            --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            transition: background-color 0.3s;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--accent-primary);
            text-shadow: 0 0 10px var(--accent-primary);
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 16px var(--shadow-color);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .metric-number {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--accent-secondary);
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Tabs Styling */
        .tabs-container {
            display: flex;
            background-color: var(--bg-card);
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-bottom: 20px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 15px 10px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.3s, color 0.3s;
            text-align: center;
            font-size: 1em;
        }
        .tab-button:hover {
            background-color: #3D3F57;
        }
        .tab-button.active {
            background-color: var(--accent-primary);
            color: var(--bg-main);
            box-shadow: 0 4px 8px rgba(77, 208, 225, 0.5);
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        .content-panel {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-bottom: 20px;
        }
        .chart-title {
            color: var(--accent-primary);
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            font-size: 1.5em;
        }
        .sidebar {
            width: 100%;
            padding: 20px;
            background-color: #35384D;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .sidebar label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent-secondary);
        }
        .sidebar select, .sidebar input[type="range"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #45485E;
            color: var(--text-primary);
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-left {
            flex: 1;
        }
        .flex-right {
            flex: 3;
        }
        @media (max-width: 1024px) {
            .flex-container {
                flex-direction: column;
            }
            .tab-button {
                font-size: 0.8em;
                padding: 10px 5px;
            }
        }
        .deep-dive-card {
            background-color: #2F3145;
            padding: 15px;
            border-left: 5px solid var(--danger);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .dive-title {
            color: var(--danger);
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        .dive-stats {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>

    <h1 class="header">üöÄ ADVANCED AVIATION SAFETY MONITOR</h1>

    <div class="metrics-grid" id="metrics-grid">
        <!-- Metrics will be inserted here by JavaScript -->
    </div>

    <div class="tabs-container">
        <button class="tab-button active" onclick="openTab(event, 'globe')">üåç 3D GLOBE (ML-SEVERITY)</button>
        <button class="tab-button" onclick="openTab(event, 'ml-risk')">üß† ML PREDICTION & RISK</button>
        <button class="tab-button" onclick="openTab(event, 'deep-dive')">üîé CRASH DEEP DIVE</button>
        <button class="tab-button" onclick="openTab(event, 'trends')">üíÄ FATALITY TRENDS</button>
    </div>

    <div id="globe" class="tab-content active">
        <div class="flex-container">
            <div class="flex-left">
                <div class="sidebar">
                    <h3 class="chart-title" style="border: none;">üéØ Filters</h3>
                    <label for="globe-year-select">Select Year:</label>
                    <select id="globe-year-select" onchange="renderGlobe()">
                        <option value="All">All Years</option>
                    </select>
                    <p style="color: var(--accent-primary); margin-top: 15px; font-size: 0.9em;">
                        Marker size and color indicate the **ML-Predicted Severity Score** (0-100).
                    </p>
                </div>
            </div>
            <div class="flex-right">
                <div class="content-panel">
                    <h3 class="chart-title">üåç Interactive 3D Globe</h3>
                    <div id="globe-chart" style="height: 750px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="ml-risk" class="tab-content">
        <div class="flex-container">
            <div class="flex-left">
                <div class="sidebar">
                    <h3 class="chart-title" style="border: none;">üß† Risk Parameters</h3>
                    <label for="severity-threshold">Minimum Severity Score:</label>
                    <input type="range" id="severity-threshold" min="0" max="100" value="50" oninput="updateMLRisk(this.value)">
                    <span id="threshold-value" style="color: var(--accent-secondary); font-weight: 700;">50</span>
                    <p style="margin-top: 15px;">Crashes Above Threshold: <span id="crashes-above-threshold" style="color: var(--danger);">...</span></p>
                </div>
            </div>
            <div class="flex-right">
                <div class="content-panel">
                    <h3 class="chart-title">‚ú® ML-Driven Severity Analysis (Fatalities vs. Aboard)</h3>
                    <div id="severity-scatter-chart" style="height: 600px;"></div>
                </div>
            </div>
        </div>
        <div class="content-panel">
            <h3 class="chart-title">ü•á Airline Weighted Risk Ranking (ML-Enhanced)</h3>
            <div id="operator-risk-chart" style="height: 600px;"></div>
        </div>
    </div>

    <div id="deep-dive" class="tab-content">
        <div class="flex-container">
            <div class="flex-left">
                <div class="sidebar">
                    <h3 class="chart-title" style="border: none;">üîé Filter High-Impact Events</h3>
                    <label for="dive-severity-min">Min Severity Score:</label>
                    <input type="range" id="dive-severity-min" min="0" max="100" value="70" oninput="updateDeepDive()">
                    <span id="dive-severity-min-value" style="color: var(--accent-secondary); font-weight: 700;">70</span>
                    <p style="margin-top: 15px;">**Total Filtered Crashes:** <span id="dive-filtered-count" style="color: var(--accent-primary);">...</span></p>
                </div>
            </div>
            <div class="flex-right">
                <div class="content-panel">
                    <h3 class="chart-title">üìã Top Filtered High-Impact Crashes</h3>
                    <div id="deep-dive-results">
                        <p style="color: var(--text-secondary);">Select filters to view crash details here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="trends" class="tab-content">
        <div class="content-panel">
            <h3 class="chart-title">üíÄ Fatality Trends Over Time</h3>
            <div id="fatality-trends-chart" style="height: 600px;"></div>
        </div>
    </div>

    <script>
        const COLORS = {
            bgMain: '#1E1E2F', bgCard: '#27293D', text: '#E0E0E0', 
            accentPrimary: '#4DD0E1', accentSecondary: '#FFCA28', 
            danger: '#EF5350', success: '#66BB6A', textSecondary: '#B0B0C4'
        };

        let AVIATION_DATA = [];

        function generateSampleData() {
            const data = [];
            const operators = ['Aeroflot', 'Pan Am', 'American Airlines', 'Air France', 'Lufthansa', 'Delta'];
            const types = ['Boeing 747', 'DC-3', 'Airbus A320', 'Cessna 172', 'Concorde'];
            const locations = ['New York', 'Paris', 'Moscow', 'Pacific Ocean', 'London'];
            
            for (let i = 0; i < 500; i++) {
                const year = 1950 + Math.floor(Math.random() * 70);
                const fatalities = Math.round(Math.pow(Math.random(), 3) * 300);
                const aboard = fatalities + Math.round(Math.random() * 50);
                const operator = operators[Math.floor(Math.random() * operators.length)];
                const type = types[Math.floor(Math.random() * types.length)];
                const ground = Math.random() < 0.05 ? Math.round(Math.random() * 10) : 0;
                
                let baseScore = (fatalities * 0.5 + ground * 0.2);
                const isJet = type.includes('Boeing') || type.includes('Airbus') || type.includes('Concorde');
                baseScore += isJet ? 15 : 0;
                baseScore += operator === 'Aeroflot' || operator === 'Pan Am' ? 20 : 0;

                let severityScore = Math.min(100, Math.log1p(baseScore) * 15 + (Math.random() * 10 - 5)).toFixed(2);
                
                data.push({
                    id: i,
                    year: year,
                    date: new Date(year, Math.floor(Math.random() * 12) + 1, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
                    fatalities: fatalities,
                    aboard: aboard,
                    ground: ground,
                    operator: operator,
                    type: type,
                    location: locations[Math.floor(Math.random() * locations.length)],
                    latitude: 30 + Math.random() * 40 * (Math.random() > 0.5 ? 1 : -1),
                    longitude: -100 + Math.random() * 200 * (Math.random() > 0.5 ? 1 : -1),
                    severityScore: parseFloat(severityScore),
                    summary: `Accident details for ${operator} flight in ${year}.`
                });
            }
            return data;
        }

        function initDataAndUI() {
            AVIATION_DATA = generateSampleData();
            updateMetrics();
            populateYearSelectors();
            renderGlobe();
            renderMLRisk();
            renderFatalityTrends();
        }

        function updateMetrics() {
            const totalRecords = AVIATION_DATA.length;
            const totalFatalities = AVIATION_DATA.reduce((sum, d) => sum + d.fatalities, 0);
            const avgSeverity = AVIATION_DATA.reduce((sum, d) => sum + d.severityScore, 0) / totalRecords;
            const yearMin = Math.min(...AVIATION_DATA.map(d => d.year));
            const yearMax = Math.max(...AVIATION_DATA.map(d => d.year));

            const metrics = [
                { label: 'Total Records', value: totalRecords.toLocaleString() },
                { label: 'Total Fatalities', value: totalFatalities.toLocaleString() },
                { label: 'Avg. Severity Score', value: avgSeverity.toFixed(2) },
                { label: 'Year Range', value: `${yearMin}-${yearMax}` }
            ];

            const grid = document.getElementById('metrics-grid');
            grid.innerHTML = metrics.map(m => `
                <div class="metric-card">
                    <div class="metric-number">${m.value}</div>
                    <div class="metric-label">${m.label}</div>
                </div>
            `).join('');
        }

        function populateYearSelectors() {
            const years = Array.from(new Set(AVIATION_DATA.map(d => d.year))).sort((a, b) => b - a);
            const select = document.getElementById('globe-year-select');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });
        }
        
        function getPlotlyLayout(title, height, yaxisTitle = '', xaxisTitle = '') {
            return {
                title: { 
                    text: title, 
                    font: { color: COLORS.text, size: 20 } 
                },
                height: height,
                paper_bgcolor: COLORS.bgCard,
                plot_bgcolor: COLORS.bgCard,
                font: { color: COLORS.text, size: 12 },
                margin: { l: 60, r: 20, t: 50, b: 60 },
                xaxis: { 
                    gridcolor: '#444', linecolor: '#444', 
                    title: xaxisTitle, 
                    zerolinecolor: '#444' 
                },
                yaxis: { 
                    gridcolor: '#444', linecolor: '#444', 
                    title: yaxisTitle,
                    zerolinecolor: '#444'
                },
                legend: { x: 1, xanchor: 'right', y: 1.1, orientation: 'h' }
            };
        }

        // --- Tab 1: 3D Globe ---
        function renderGlobe() {
            const selectedYear = document.getElementById('globe-year-select').value;
            let filteredData = AVIATION_DATA;
            if (selectedYear !== 'All') {
                filteredData = AVIATION_DATA.filter(d => d.year == selectedYear);
            }

            const data = [{
                type: 'scattergeo',
                lon: filteredData.map(d => d.longitude),
                lat: filteredData.map(d => d.latitude),
                mode: 'markers',
                marker: {
                    size: filteredData.map(d => Math.log1p(d.severityScore) * 3 + 4),
                    color: filteredData.map(d => d.severityScore),
                    colorscale: [[0, COLORS.success], [0.5, COLORS.accentPrimary], [1, COLORS.danger]],
                    opacity: 0.8,
                    colorbar: { title: 'Severity Score', tickfont: { color: COLORS.text } },
                    line: { width: 1, color: COLORS.text }
                },
                hovertext: filteredData.map(d => 
                    `<b>${d.operator}</b><br>Date: ${d.date}<br>Fatalities: ${d.fatalities}<br><b>Severity: ${d.severityScore}</b>`
                ),
                hovertemplate: "%{hovertext}<extra></extra>"
            }];

            const layout = {
                ...getPlotlyLayout(`üåç 3D Globe - ${filteredData.length} Crashes ${selectedYear !== 'All' ? '(' + selectedYear + ')' : '(All Years)'}`, 750),
                geo: {
                    scope: 'world',
                    showland: true,
                    landcolor: '#3D3F57',
                    countrycolor: '#B0B0C4',
                    coastlinecolor: '#B0B0C4',
                    bgcolor: COLORS.bgCard,
                    projection: { type: 'orthographic' }
                }
            };

            Plotly.newPlot('globe-chart', data, layout, { responsive: true });
        }

        // --- Tab 2: ML Prediction & Risk ---
        function renderMLRisk() {
            renderSeverityScatter();
            renderOperatorRiskRanking();
        }

        function renderSeverityScatter() {
            const threshold = parseFloat(document.getElementById('severity-threshold').value);
            document.getElementById('threshold-value').textContent = threshold;
            const highSeverityCount = AVIATION_DATA.filter(d => d.severityScore >= threshold).length;
            document.getElementById('crashes-above-threshold').textContent = highSeverityCount.toLocaleString();

            const data = [
                {
                    x: AVIATION_DATA.map(d => d.aboard),
                    y: AVIATION_DATA.map(d => d.fatalities),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'All Crashes',
                    marker: {
                        size: AVIATION_DATA.map(d => Math.log1p(d.fatalities) + 4),
                        color: AVIATION_DATA.map(d => d.severityScore),
                        colorscale: 'Plasma',
                        showscale: true,
                        colorbar: { title: 'Severity Score', tickfont: { color: COLORS.text } }
                    },
                    text: AVIATION_DATA.map(d => 
                        `Operator: ${d.operator}<br>Severity: ${d.severityScore}<br>Fatalities: ${d.fatalities}`
                    ),
                    hovertemplate: "%{text}<extra></extra>"
                },
                {
                    x: AVIATION_DATA.filter(d => d.severityScore >= threshold).map(d => d.aboard),
                    y: AVIATION_DATA.filter(d => d.severityScore >= threshold).map(d => d.fatalities),
                    mode: 'markers',
                    type: 'scatter',
                    name: `High Severity (‚â• ${threshold})`,
                    marker: {
                        size: AVIATION_DATA.filter(d => d.severityScore >= threshold).map(d => Math.log1p(d.fatalities) * 2 + 5),
                        color: COLORS.danger,
                        line: { width: 2, color: COLORS.text }
                    }
                }
            ];

            const layout = {
                ...getPlotlyLayout('‚ú® ML-Driven Severity Analysis (Fatalities vs. Persons Aboard)', 600, 'Total Fatalities (Log)', 'Total Persons Aboard (Log)'),
                xaxis: { 
                    type: 'log', title: 'Total Persons Aboard (Log Scale)', gridcolor: '#444', linecolor: '#444' 
                },
                yaxis: { 
                    type: 'log', title: 'Total Fatalities (Log Scale)', gridcolor: '#444', linecolor: '#444'
                }
            };
            
            Plotly.newPlot('severity-scatter-chart', data, layout, { responsive: true });
        }

        function renderOperatorRiskRanking() {
            const operatorStats = {};

            AVIATION_DATA.filter(d => d.operator !== 'Unknown').forEach(d => {
                if (!operatorStats[d.operator]) {
                    operatorStats[d.operator] = { crashes: 0, fatalities: 0, severitySum: 0 };
                }
                operatorStats[d.operator].crashes += 1;
                operatorStats[d.operator].fatalities += d.fatalities;
                operatorStats[d.operator].severitySum += d.severityScore;
            });

            let rankedOperators = Object.keys(operatorStats).map(op => {
                const stats = operatorStats[op];
                const avgSeverity = stats.severitySum / stats.crashes;
                const weightedRiskScore = (stats.crashes * 1.5) + (stats.fatalities / 10) + (avgSeverity * 2);
                return {
                    operator: op,
                    weightedRiskScore: weightedRiskScore
                };
            }).filter(op => op.weightedRiskScore > 10).sort((a, b) => b.weightedRiskScore - a.weightedRiskScore).slice(0, 15);

            const data = [{
                y: rankedOperators.map(op => op.operator),
                x: rankedOperators.map(op => op.weightedRiskScore),
                orientation: 'h',
                type: 'bar',
                marker: {
                    color: rankedOperators.map(op => op.weightedRiskScore),
                    colorscale: 'Cividis',
                    line: { color: COLORS.bgMain, width: 1 }
                },
                text: rankedOperators.map(op => op.weightedRiskScore.toFixed(1)),
                textposition: 'outside'
            }];

            const layout = {
                ...getPlotlyLayout('ü•á Airline Weighted Risk Ranking (ML-Enhanced)', 600, 'Airline Operator', 'Weighted Risk Score'),
                yaxis: { automargin: true, categoryarray: rankedOperators.map(op => op.operator), categoryorder: "array" }
            };

            Plotly.newPlot('operator-risk-chart', data, layout, { responsive: true });
        }

        function updateMLRisk(value) {
            document.getElementById('severity-threshold').value = value;
            renderSeverityScatter();
        }

        // --- Tab 3: Deep Dive ---
        function updateDeepDive() {
            const minSeverity = parseFloat(document.getElementById('dive-severity-min').value);
            document.getElementById('dive-severity-min-value').textContent = minSeverity;

            const filtered = AVIATION_DATA
                .filter(d => d.severityScore >= minSeverity)
                .sort((a, b) => b.severityScore - a.severityScore);

            document.getElementById('dive-filtered-count').textContent = filtered.length.toLocaleString();

            const resultsContainer = document.getElementById('deep-dive-results');
            resultsContainer.innerHTML = '';

            if (filtered.length === 0) {
                resultsContainer.innerHTML = `<p style="color: ${COLORS.textSecondary};">No crashes match the selected minimum severity score.</p>`;
                return;
            }

            filtered.slice(0, 10).forEach(d => {
                const card = document.createElement('div');
                card.className = 'deep-dive-card';
                card.innerHTML = `
                    <div class="dive-title">üí• ${d.operator} (${d.date}) - Severity: ${d.severityScore}</div>
                    <div class="dive-stats">
                        Location: ${d.location} | Aircraft: ${d.type} | Fatalities: ${d.fatalities} / ${d.aboard} aboard
                    </div>
                    <p style="margin-top: 5px; color: ${COLORS.textSecondary}; font-style: italic;">Summary: ${d.summary}</p>
                `;
                resultsContainer.appendChild(card);
            });
        }

        // --- Tab 4: Fatality Trends ---
        function renderFatalityTrends() {
            const yearlyData = AVIATION_DATA.reduce((acc, d) => {
                if (!acc[d.year]) {
                    acc[d.year] = { fatalities: 0, crashes: 0 };
                }
                acc[d.year].fatalities += d.fatalities;
                acc[d.year].crashes += 1;
                return acc;
            }, {});

            const sortedYears = Object.keys(yearlyData).sort();
            const totalFatalities = sortedYears.map(year => yearlyData[year].fatalities);
            const totalCrashes = sortedYears.map(year => yearlyData[year].crashes);

            const data = [
                {
                    x: sortedYears,
                    y: totalFatalities,
                    mode: 'lines+markers',
                    name: 'Total Fatalities',
                    fill: 'tozeroy',
                    line: { color: COLORS.danger, width: 3 },
                    marker: { size: 8, color: COLORS.danger, line: { color: COLORS.bgCard, width: 1.5 } }
                },
                {
                    x: sortedYears,
                    y: totalCrashes,
                    mode: 'lines',
                    name: 'Total Crashes',
                    yaxis: 'y2',
                    line: { color: COLORS.accentPrimary, width: 2, dash: 'dot' }
                }
            ];

            const layout = {
                ...getPlotlyLayout('üíÄ Fatality and Crash Trends Over Time', 600, 'Total Fatalities'),
                yaxis2: {
                    title: 'Total Crashes',
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false,
                    titlefont: { color: COLORS.accentPrimary },
                    tickfont: { color: COLORS.accentPrimary }
                },
                legend: { x: 0, xanchor: 'left', y: 1.1, orientation: 'h' }
            };

            Plotly.newPlot('fatality-trends-chart', data, layout, { responsive: true });
        }


        // --- UI Functions ---
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove('active');
            }
            const tablinks = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            // Re-render charts on tab switch to ensure responsiveness
            if (tabName === 'globe') renderGlobe();
            if (tabName === 'ml-risk') renderMLRisk();
            if (tabName === 'deep-dive') updateDeepDive();
            if (tabName === 'trends') renderFatalityTrends();
        }

        window.onload = initDataAndUI;
    </script>
</body>
</html>